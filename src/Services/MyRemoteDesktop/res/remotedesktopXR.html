<!DOCTYPE html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script> 

    <title>MyRemoteDesktop</title>
    <script type="text/javascript">  


   var autoRefreshJob; 
   function httpGet(theUrl)
    {
    var xmlHttp = null;
    xmlHttp = new XMLHttpRequest();
    xmlHttp.open( "GET", theUrl, true ); //Second parameter is async
    xmlHttp.send( null );
    return xmlHttp.responseText;
    } 
    
    function command(theCommand)
     {
       var randomnumber=Math.floor(Math.random()*100000);
       var today = new Date();
       var unique = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate()+'-'+today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds()+'-'+randomnumber;
       httpGet("cmd?"+theCommand+"&t="+unique); 
     } 


   function doMovement(e) 
   {
    img = document.getElementById("screenImage");

    var x = 3+img.naturalWidth * ( e.clientX / img.width ) ;
    var y = 3+img.naturalHeight * ( e.clientY / img.height );
     
    var coor = "Coordinates: (" + x + "," + y + ")";
    document.getElementById("coordinates").innerHTML = coor;
    command("x="+x+"&y="+y);
   }

  function clearCoordinates() 
  {
    document.getElementById("coordinates").innerHTML = "";
  }

   function refreshScreen()
   {  
      var randomnumber=Math.floor(Math.random()*100000);
      var today = new Date();
      var unique = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate()+'-'+today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds()+'-'+randomnumber;


      var scene = document.querySelector('a-scene'); 
      //console.log(THREE);
      //console.log('Trying to refresh scene ',scene);

      var plane = scene.querySelector('a-plane'); 
      console.log('Trying to refresh plane ',plane);
      plane.setAttribute("material", "src", "screen.jpg?t="+unique) 
      //plane.setAttribute('material', 'color','red');
      plane.src='screen.jpg?t='+unique; 
      plane.needsUpdate = true;

      //var screenImage = scene.querySelector('#feed');
      //console.log('Trying to refresh image ',screenImage);

      //screenImage.setAttribute("material", "src", "screen.jpg?t="+unique) 
      //screenImage.src='screen.jpg?t='+unique; 
      //screenImage.needsUpdate = true;

      //screenImage.material.map=new THREE.TextureLoader().load('screen.jpg?t='+unique);  
   } 

  function autoRefreshScreen()
  {
    refreshScreen();
  }
  

  function initAutoRefresh() 
  {
    autoRefreshJob = setInterval(function() { autoRefreshScreen(); }, $FRAMERATE$ );
  }

  function stopAutoRefresh() 
  {
    clearInterval(autoRefreshJob); 
  }

  document.onkeypress = function (e) 
  {
    e = e || window.event; 
    command('k='+(e.keyCode || e.which));
  };

  AFRAME.registerComponent('screen-click', {
  init: function () {
    var sceneEl = this.el;
    this.el.addEventListener('click', function (evt) {
    console.log('Screen clicked at: ', evt.detail.intersection.point);
     //refreshScreen();
    });
  }
});

// Component to change to a sequential color on click.
AFRAME.registerComponent('cursor-listener', {
  init: function () {
    var lastIndex = -1;
    var COLORS = ['red', 'green', 'blue'];
    this.el.addEventListener('click', function (evt) {
      lastIndex = (lastIndex + 1) % COLORS.length;
      this.setAttribute('material', 'color', COLORS[lastIndex]);
      console.log('I was clicked at: ', evt.detail.intersection.point);
    });
  }
});
  </script>


</head>
  <body onload="initAutoRefresh();">
    <a-scene do-something> 
    <a-assets>
      <img id="skyTexture" src="background.jpg" >
      <img id="feed" src="screen.jpg">
    </a-assets>  
 


      <a-entity cursor="downEvents: triggerdown; upEvents: triggerUp" 
                geometry="primitive: ring; radiusInner: 0.03; radiusOuter: 0.05"
                material="color: blue; shader: flat"
                position="0 0 -1">
      </a-entity>
      <a-sphere position="-2 2.25 -6" radius="0.25" src="https://raw.githubusercontent.com/aframevr/sample-assets/master/assets/images/space/moon_1024.jpg"></a-sphere>
      <a-sphere position="0 1.25 -6" radius="1.25" src="https://raw.githubusercontent.com/aframevr/sample-assets/master/assets/images/space/earth_atmos_4096.jpg"></a-sphere>
      <a-plane screen-click position="0 0 -4" rotation="-20 0 0" width="3.84" height="1.08" 
               src="#feed" 
               onclick="refreshScreen();" 
               ondblclick="command('dblclick=1');"
               onmouseup="command('mouseup=1');"
               onmousedown="command('mousedown=1');"
               onmousemove="doMovement(event)" 
               onmouseout="clearCoordinates()"></a-plane>
      <a-sky src="#skyTexture" ></a-sky>


      <!-- Hands --><!-- Match Oculus Go controller if present, regardless of hand. -->
      <a-entity oculus-go-controls></a-entity>

      <!-- Match Oculus Go controller if present and for specified hand. -->
      <a-entity oculus-go-controls="hand: left"></a-entity>
      <a-entity oculus-go-controls="hand: right"></a-entity>

      <a-entity position="0 1.6 2" camera look-controls wasd-controls></a-entity>

      <a-camera>
	   <a-cursor fuse=“true” fuse-timeout=“1000”></a-cursor>
      </a-camera>

    </a-scene>
 <p id="coordinates"></p>
 Powered by <a href="https://github.com/AmmarkoV/AmmarServer/wiki" target="_new">AmmarServer</a>
  </body>
</html>
