#!/bin/bash
 
CONCURRENT_CONNECTIONS=2000
SERVER_TO_TESTLOCAL="127.0.0.1:8080"
SERVER_TO_TESTAWAY="192.168.20.8:8080"
SERVER_TO_TEST="$SERVER_TO_TESTLOCAL"

URI_TO_TEST="logo.png"
#URI_TO_TEST="controlpanel.html"

echo " " > trial1.raw

for i in `seq 1 $CONCURRENT_CONNECTIONS`;
do  
# -b 
(time wget --tries=100 -qO- http://$SERVER_TO_TEST/$URI_TO_TEST > /dev/null) 1> /dev/null 2>> trial1.raw &
done    

echo "Waiting for trial to end"

RUNNING_WGETS=`ps -A | grep wget`

while [ -n "$RUNNING_WGETS" ] 
do 
 sleep 1
 RUNNING_WGETS=`ps -A | grep wget`
done
echo "Trial Ended , Processing output"

cat trial1.raw | grep real| cut -d'	' -f2 | grep -oE "[0-9]\.[0-9][0-9][0-9]"  > trial1.filtered


 

gnuplot <<EOF
set terminal png;
set output "ammarserver.png";
set ylabel "AmmarServer Response Time Seconds";
set xlabel "AmmarServer Requests";
plot "trial1.filtered" using 1 with lines  title "AmmarServer , $URI_TO_TEST , $SERVER_TO_TEST"
EOF



echo "Done"

exit 0
