#!/bin/bash
#sudo apt-get install siege ?

CONCURRENT_CONNECTIONS=1300
INSTANCES=7

if [ $# -ne 1 ]
then 
  echo "Using default concurrent connection number"
else
 CONCURRENT_CONNECTIONS=$1 
fi

SERVER_TO_TESTLOCAL="127.0.0.1:8080"
SERVER_TO_TESTAWAY="192.168.20.8:8080"
#SERVER_TO_TESTAWAY="139.91.185.28"
SERVER_TO_TEST="$SERVER_TO_TESTLOCAL"





for fn in `seq $INSTANCES`; do
    echo "Starting siege instance $fn"
    siege -c "$CONCURRENT_CONNECTIONS" -i -t 1m -d 3 "$SERVER_TO_TEST" 2> siege"$fn".log &
done

RUNNING_SIEGE=`ps -A | grep siege`
while [ -n "$RUNNING_SIEGE" ] 
do 
 sleep 1
 RUNNING_SIEGE=`ps -A | grep siege`
done
echo "Trial Ended , Processing output"

for fn in `seq $INSTANCES`; do
    echo "Report on siege instance $fn"
    cat siege"$fn".log  | grep "Transactions:"	
    cat siege"$fn".log  | grep "Failed transactions:"
    cat siege"$fn".log  | grep "Transaction rate:"
done

 
echo "Finished with $SERVER_TO_TEST" 

exit 0
